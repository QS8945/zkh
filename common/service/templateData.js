!function(e){function o(e,o){var t={SUCCESS:0,ADMIN_USERID:1,MODELINGAPP_ID:"5840fcd387c1ef26b4be2aa3",MODELINGAPP_CATEGORYID:"60",IOTPLATFORM_ID:"58589df3396a14188dedfe7f",IOTPLATFORM_CATEGORYID:"61",BUSINESSOPERATIONS_ID:"5aaf7b6a866506da2288c10c",BUSINESSOPERATIONS_CATEGORYID:"62",PERMISSIONS_ID:"585cc9756d96de37408eae5c",PERMISSIONS_CATEGORYID:"63",USERMESSAGE_ID:"58be5b1079e68c4f52d4e032",USERMESSAGE_CATEGORYID:"64",TREENODE:{},isLogin:!1,BASIC_TREENODE:{},sessionId:"",LastClickNodeId:"",BYTECODE_ENDIANTYPE_BIG:0,BYTECODE_ENDIANTYPE_LITTE:1,BYTECODE_CHECKTYPE_NONE:0,BYTECODE_CHECKTYPE_CRC16:1,BYTECODE_CODETYPE_NONE:0,BYTECODE_CODETYPE_HEX:1,BYTECODE_MBAP_NONE:0,BYTECODE_MBAP_MBAP:1,MODBUS_CLIENT:1,MODBUS_SERVE:4097,OPCDA_SERVE:4102,Common:8712,DATATEMPLATE_MODBUS:256,DATATEMPLATE_MODBUS_MBAP:4097,DATATEMPLATE_EXCEL:1024,DATATEMPLATE_POSITION:1280,DATATEMPLATE_OPERATION:768,DATATEMPLATE_TRIGGERWARNING:512,DATATEMPLATE_COMMON:1536,DATATEMPLATE_GENERAL_I:1111,TIMEUNIT_SEC:1,TIMEUNIT_MIN:60,TIMEUNIT_HOUR:3600,START:1,STOP:0,ISTABMARK:!0,ISMTABMARK:!0,CHILD_NODE_LIST:"",mbsInterval:"",alarmInterval:"",ERR_MSG:500,SUCCESS:0,CONNECT_OUT_TIME:1001,FILE_NOT_FIND:1002,INSEART_ERROR:2001,DELETE_ERROR:2002,UPDATE_ERROR:2003,SELECT_ERROR:2004,NULL_OBJ:2e3,NULL_PARAM:3e3,PARAM_ERROR:3001,SESSION_TIMEOUT:4001,NO_PERMISSION:5e3,ERR_REG_LACK:1001,ERR_REG_HAS_USER:1002,ERR_PW_NOT_EQUAL:1003,RIGHT_TREEID:"",MODELINGAPPTREE:"modelingAppTree",IOTPLATFORMTREE:"iotPlatformTree",PERMISSIONTREE:"permissionsTree",USERMESSAGETREE:"userMessageTree",SHOWMENU_NODETYPE:",4321,8417,12513,26,20705,4194,28770,8290,16482,16609,32930,37026,41122,",timeInterval:1e4,iotTimeInterval:1e11,count:0,DEVDATAMONITORCONTROL:0,DEVGRAPHMODELCONTROL:0,DEVDATAMONITORCONTROLLOOP:1,httpURL:"https://127.0.0.1/",controlURL:"",restURL:"rest/",ISUSEWS:!1,appComReadStr:"",WEBSOCKETLINKINFO:"",USERID:"",updateZtreeNode:function(e){var o=$.fn.zTree.getZTreeObj(IOTPLATFORMTREE),t=o.getNodeByParam("id",parent.$("#myTab li.active").eq(0).attr("id"),null),n=o.getNodeByParam("id",t.parentNodeId,null);n.name=e,o.updateNode(n),$("#"+n.id+" a").html(e)},getISUSEWS:function(){o.getReadBasicGlbConfig().then(function(o){if(o.data&&o.data.operCode==TEMPLATEDATA.SUCCESS){var n=data.data.generalConfigList;for(var a in n)"ISUSEWS"==n[a].configType&&(t.ISUSEWS=n[a].configValue,console.log("WS启用状态:",n[a].configValue))}else e.alert(o.message,{icon:5,shift:6})})},updateTempalateNode:function(e){$.fn.zTree.getZTreeObj(MODELINGAPPTREE).updateNode(e)},updateRealData:function(t,n){if(!$.fn.getZTreeObj(IOTPLATFORMTREE))return e.msg("根节点异常",{icon:0,shift:6});o.getFindRealRecord({time:time,deviceAndItems:deviceAndItems}).then(function(o){if(o.data&&o.data.operCode==TEMPLATEDATA.SUCCESS){var t=data.data;return loadMbsDataTable(t,itemIdArr)}e.alert(o.message,{icon:5,shift:6})})},ws:{},sendInterval:"",responseInterval:"",sendMsg:"",sendAllMsg:"",receiveMsg:null,retryTimes:"",reqOverTime:"",minReqTime:"",reqCount:0,retryTimesCount:0,webSocketMsgId:"",userIdEndStr:"No",connect:function(n,a){o.getReadBasicGlbConfig().then(function(o){if(o.data&&o.data.operCode==t.SUCCESS){var s=o.data.data.generalConfigList;for(var l in s)if("ISUSEWS"==s[l].configType){if(t.ISUSEWS=s[l].configValue,console.log("WS启用状态:",s[l].configValue),console.log(344,t.ISUSEWS),"false"==t.ISUSEWS||0==t.ISUSEWS)return console.log("WS关闭连接,不启用WS"),!1;var r=!1;if($("#modal-table-client").modal("show"),$("#modal-table-wait-client").modal("show"),$("#webSocketDisplay").hide(),$("#webSocketDisplays").hide(),t.retryTimesCount=0,t.reqCount=0,console.log("wss://"+n+"?OwnerUserId="+a+t.userIdEndStr),!("WebSocket"in window))return e.alert("你的浏览器不支持WebSocket，请选择高版本的浏览器！",{icon:5,shift:6});try{t.ws=new WebSocket("wss://"+n+"?OwnerUserId="+a+t.userIdEndStr),console.log("313行",t.ws)}catch(e){console.log("捕获webSocket错误",e),addWebSocketMsg(t.sendAllMsg)}t.ws.onopen=function(){console.log("打开连接")},t.ws.onmessage=function(o){t.receiveMsg=o.data,console.log("================="),console.log(237,t.receiveMsg),console.log(238,t.sendMsg),t.sendMsg==t.receiveMsg?(clearInterval(t.responseInterval),e.msg("恭喜您操作已提交",{icon:6}),r=!0,t.ws.close()):t.retryTimesCount==t.retryTimes&&($("#webSocketDisplay").hide(),$("#webSocketDisplays").show())},t.ws.onerror=function(){webSocketFlag=!0,console.log("错误连接")},t.ws.onclose=function(){console.log("354行",r),r||addWebSocketMsg(sendAllMsg),console.log("关闭连接"),$("#modal-table-client").modal("hide"),clearInterval(t.sendInterval),clearInterval(t.responseInterval)}}}else e.alert(o.message,{icon:5,shift:6})})},minIntervalTime:0,sendProcess:function(n){o.getReadBasicGlbConfig().then(function(o){if(o.data&&o.data.operCode==t.SUCCESS){console.log(o);var a=o.data.data.generalConfigList;for(var s in a)if("ISUSEWS"==a[s].configType){if(t.ISUSEWS=a[s].configValue,console.log("WS启用状态:",a[s].configValue),console.log(344,t.ISUSEWS),"false"==t.ISUSEWS||0==t.ISUSEWS)return console.log(t.sendAllMsg),t.addWebSocketMsg(t.sendAllMsg),!1;t.sendInterval=setInterval(function(){1==t.ws.readyState?(t.ws.send(n),console.log("发送状态","发送完毕！！！"),t.checkResponseMsg(),t.responseInterval=setInterval(t.checkResponseMsg,1e3),clearInterval(t.sendInterval),$("#modal-table-client").modal("hide")):0==t.ws.readyState&&(10==t.minIntervalTime?(clearInterval(t.sendInterval),t.ws.close(),t.minIntervalTime=0,$("#webSocketDisplay").hide(),$("#webSocketDisplays").show()):($("#modal-table-client").modal("show"),console.log("webSocket开启中。。。"),t.minIntervalTime++))},1e3)}}else e.alert(o.message,{icon:5,shift:6})})},checkResponseMsg:function(){console.log("开启检查!超时时间："+t.reqOverTime+",重试次数："+t.retryTimes),console.log(t.reqCount),t.reqCount==t.reqOverTime?(console.log("重试计数器："+t.retryTimesCount),null==t.receiveMsg||rtemplateData.eceiveMsg!=sendMsg?t.retryTimesCount!=t.retryTimes?(console.log("重发！！！"),t.ws.send(t.sendAllMsg),t.reqCount=0,t.retryTimesCount++):(clearInterval(t.responseInterval),t.ws.close(),console.log("已超过最大重试次数，关闭连接！")):clearInterval(t.responseInterval)):t.reqCount+=1e3},oneFlag:!0,addWebSocketMsg:function(n){o.getAddWebSocket({sendMsg:n}).then(function(o){if(o.data&&o.data.operCode==t.SUCCESS){console.log("添加webSocket记录成功");var n=o.data.data;t.webSocketMsgId=n,e.msg("恭喜您操作已提交",{icon:6}),t.oneFlag&&(t.oneFlag=!1,console.log("sendAllMsg"+t.sendAllMsg),t.connect(t.WEBSOCKETLINKINFO,t.USERID),t.sendProcess(t.appComReadStr))}else e.alert(o.message,{icon:5,shift:6})})},stringToBytes:function(e){for(var o,t,n=[],a=0;a<e.length;a++){o=e.charCodeAt(a),t=[];do{t.push(255&o),o>>=8}while(o);n=n.concat(t.reverse())}return n},updateNode:function(e,o){$.fn.zTree.getZTreeObj(o).updateNode(e)},getNode:function(e,o,t){return $.fn.zTree.getZTreeObj(t).getNodeByParam(e,o,null)},loopTime:"",getLoopRequestTime:function(){o.getLoopRequestMs().then(function(o){o.data&&o.data.operCode==TEMPLATEDATA.SUCCESS?loopTime=data.data:e.alert(o.message,{icon:5,shift:6})})},situationIntevals:"",situationInteval:function(){getTriggerInfos(),clearInterval(t.situationIntevals),t.situationIntevals=setInterval(getTriggerInfos,loopTime)},getTriggerInfos:function(){o.getAllTriggerModelDataRealOne().then(function(o){if(o.data&&o.data.operCode==t.SUCCESS){for(var n=o.data.data,a=0,s=0;s<n.length;s++)1==n[s].devTriggerStatus&&2==n[s].userTriggerStatus&&a++;a>0?$("#alarmImage").show():$("#alarmImage").hide(),$(".alarmCount").eq(0).text(a)}else e.alert(o.message,{icon:5,shift:6})})}};return t}e.module("app.service").factory("TEMPLATEDATA",o),o.$inject=["layer","API"]}(window.angular);