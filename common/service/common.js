!function(e){function t(e,t,a,o){var n={COMBASICTYPE1H_CLIENT:0,COMBASICTYPE3_MODBUS:16,MESSAGECODE_BASICTYPE3_OPCDA:18,Logo_Max_Size:2e3,Station_Max_Size:1e4,currentTime:function(e){return e=new Date(Date.parse(e.substring(0,19).replace(/-/g,"/"))).getTime()},timeToYearAndMonthAndDay:function(e){var t=new Date(e),a=t.getFullYear(),o=t.getMonth()+1;o=o<10?"0"+o:o;var n=t.getDate();n=n<10?"0"+n:n;var i=t.getHours();i=i<10?"0"+i:i;var d=t.getMinutes();d=d<10?"0"+d:d;var r=t.getSeconds();return r=r<10?"0"+r:r,a+"-"+o+"-"+n+" "+i+":"+d+":"+r},ipToNumber:function(e){var t=0;if(""==e)return null;var a=e.split(".");return 4!=a.length?null:(t+=parseInt(a[0])<<24,t+=parseInt(a[1])<<16,t+=parseInt(a[2])<<8,t+=parseInt(a[3])<<0,t>>>=0)},numberToIp:function(e){var t="";return null==e||""==e?t:t+=(e<<0>>>24)+"."+(e<<8>>>24)+"."+(e<<16>>>24)+"."+(e<<24>>>24)},ERR_MSG:500,MODBUS_CLIENT:16,MODBUS_SERVE:4112,OPCDA_SERVE:4117,treeNode:"",permission:"",modalName:"",dataTemplateClickType:"",modelFun:function(e,t){if(1==isSavedFirst)return Message.openInfo("信息提示","此模板已经保存过，无法克隆，请新建模板",2500),!1;$("#modalModel").modal({backdrop:"static",keyboard:!1}),$("#hiddenDataModel").val(e),$("#TreeBody").empty(),dataTemplateClickType=t,void 0!=t&&(modalName=t),$("#modelSelect").empty(),$("#modalModel").attr("data-type",e);var a=$("#modelingApp",window.parent.document).attr("data-id"),o=$("#modelingApp",window.parent.document).attr("data-categoryId"),n=httpURL+restURL+"catalog/getTemplateTree";if("clone"==t&&(n=httpURL+restURL+"catalog/getApplicationTemplateTree"),"communication"==e){if(""==$("#deviceCtId").val());else{var i=$("#deviceCtId").val(),d=$("#deviceCtIds").attr("data-id");console.log("100行",d),void 0!=d&&$("#modelSelect").append("<option value="+d+">"+i+"</option>")}$("#modalTitle").text("选择通信模板");var r={id:a,secondLevelMenu:o,nodeTypes:"65 129 8 4321"};ajaxSelect(n,r)}if("data"==e){n=httpURL+restURL+"catalog/getDataTemplateTree";var l,d,p,r,s;if("deviceDataTemplateMonitor"==t){if(l=$("#deviceDataTemplateMonitor").val(),d=$("#deviceDataTemplateMonitorId").attr("data-id"),p=$("#deviceDataTemplateMonitorDtType").val(),s=$("#deviceDataTemplateMonitorDtProp").val(),$("#modelSelect").data("type",p),""!=l){var c=l.split(",");d=d.split(" ");for(var u=0;u<c.length-1;u++)$("#modelSelect").append('<option data-prop="'+s+'" data-type="'+p+'" value="'+d[u]+'">'+c[u]+"</option>")}r={secondLevelMenu:o,nodeTypes:"65 129 8 8417",filterMbsFunCode:20},$("#modalTitle").text("选择实时监测模板")}if("deviceDataTemplateControl"==t){if(l=$("#deviceDataTemplateControl").val(),d=$("#deviceDataTemplateControlId").attr("data-id"),p=$("#deviceDataTemplateControlDtType").val(),s=$("#deviceDataTemplateControlDtProp").val(),$("#modelSelect").data("type",p),""!=l){var c=l.split(",");d=d.split(" ");for(var u=0;u<c.length-1;u++)$("#modelSelect").append('<option data-prop="'+s+'" data-type="'+p+'" value="'+d[u]+'">'+c[u]+"</option>")}r={secondLevelMenu:o,nodeTypes:"65 129 8 8417",filterMbsFunCode:20},$("#modalTitle").text("选择远程控制模板")}if("deviceDataTemplateOther"==t){if(l=$("#deviceDataTemplateOther").val(),d=$("#deviceDataTemplateOtherId").attr("data-id"),p=$("#deviceDataTemplateOtherDtType").val(),s=$("#deviceDataTemplateOtherDtProp").val(),$("#modelSelect").data("type",p),""!=l){var c=l.split(",");d=d.split(" ");for(var u=0;u<c.length-1;u++)$("#modelSelect").append('<option data-prop="'+s+'" data-type="'+p+'" value="'+d[u]+'">'+c[u]+"</option>")}r={secondLevelMenu:o,nodeTypes:"65 129 8 8417"},$("#modalTitle").text("选择其他模板")}ajaxSelect(n,r,"data")}if("graph"==e){if(""===$("#deviceGraphModelName").val());else for(var l=$("#deviceGraphModelName").val().split(","),d=$("#deviceGraphModelId").attr("data-id").split(" "),u=0;u<l.length-1;u++)$("#modelSelect").append("<option value="+d[u]+">"+l[u]+"</option>");$("#modalTitle").text("选择图形模板");var r={id:a,secondLevelMenu:o,nodeTypes:"65 129 8 12513"};ajaxSelect(n,r)}if("count"==e){if(""===$("#deviceCountModelName").val());else for(var l=$("#deviceCountModelName").val().split(","),d=$("#deviceCountModelId").attr("data-id").split(" "),u=0;u<l.length-1;u++)$("#modelSelect").append("<option value="+d[u]+">"+l[u]+"</option>");$("#modalTitle").text("选择统计分析模板");var r={id:a,secondLevelMenu:o,nodeTypes:"65 129 8 16609"};ajaxSelect(n,r)}if("alarm"==e){if(""===$("#deviceAlarmModelName").val());else for(var l=$("#deviceAlarmModelName").val().split(","),d=$("#deviceAlarmModelId").attr("data-id").split(" "),u=0;u<l.length-1;u++)$("#modelSelect").append("<option value="+d[u]+">"+l[u]+"</option>");$("#modalTitle").text("选择触发模型模板");var r={id:a,secondLevelMenu:o,nodeTypes:"65 129 8 20705"};ajaxSelect(n,r)}if("all"==e){$("#modalTitle").text("请选择模板");var r={id:a,secondLevelMenu:o,nodeTypes:"65 129 8 4321 8417 12513 16609 20705"};ajaxSelect(n,r)}},checkSelect:function(e){var t=!0;return $("#modelSelect option").each(function(){if($(this).attr("value")==e.id)return Message.openInfo("信息提示","该模型已选择",2500),$("#hiddenSelect").empty(),t=!1,!1}),t},modelSel:function(){var e=[],t=$("#modalModel");$("#modelSelect option").length>1&&$.each($("#modelSelect option"),function(){e.push($(this).attr("value"))});for(var a=0;a<e.length;a++)if(e.sort()[a]==e.sort()[a+1])return Message.openInfo("信息提示","选择项中有重复值,请检查",2500),!1;var o=t.attr("data-type"),n="",i="";if($("#modelSelect option").each(function(){n+=$(this).text()+",",i+=$(this).attr("value")+" "}),"communication"==o){var d=n.split(",")[0],r=i.split(" ")[0];$("#deviceCtId").val(d),$("#deviceCtIds").attr("data-id",r);var l=$("#modelSelect").children("option").eq(0),p=l.attr("value"),s=httpURL+restURL+"comTemplate/readComTemplate";$("#modelSelect").children().length>0?$.ajax({url:s,dataType:"json",type:"POST",data:{nodeId:p},success:function(e){if(e.operCode==SUCCESS){var t=e.data.data;if(null!=t&&void 0!=t){var a=t.ctType+"";a=a.length<4?"0x00"+a:"0x"+a,$("#deviceCtType").val(a),isTcpIpClient(a)?($("#connKeyDevice").val(""),$("#linkKeyWordSelect").show()):$("#linkKeyWordSelect").hide()}else $("#linkKeyWordSelect").hide()}else{if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;var o=codeToMsg(e.operCode);Message.openInfo("信息提示",o,3e3)}},error:function(e){e.responseText==ERR_MSG&&Message.openInfo("信息提示","服务器繁忙！",2500)}}):($("#deviceCtType").val(""),$("#linkKeyWordSelect").hide(),$("#connKeyDevice").val(""))}if("data"==o){var c=$("#modelSelect option"),u=$("#dtType").data("type");if(u)$.each(c,function(e,t){if(u!=$(t).data("type"))return Message.openInfo("信息提示","请选择相同类型的数据模板",2500),!1});else{var f=[],v=[];if($.each(c,function(e,t){f.push($(t).data("type")),v.push($(t).data("prop"))}),f.length>1)for(var a=0;a<f.length-1;a++)for(var m=a+1;m<f.length;m++)if(f[a]!=f[m]||v[a]!=v[m])return Message.openInfo("信息提示","请选择相同模板类型和模板属性的数据模板",2500),!1;$("#"+modalName+"DtType").val(f[0]),$("#"+modalName+"DtProp").val(v[0]),isModBus(f[0])&&$("#slaveAddr").show(),""==$("#deviceDataTemplateMonitorDtType").val()&&""==$("#deviceDataTemplateControlDtType").val()&&""==$("#deviceDataTemplateOtherDtType").val()&&($("#slaveAddrDevice").val(""),$("#slaveAddr").hide())}$("#"+modalName).val(n),$("#"+modalName+"Id").attr("data-id",i)}"graph"==o&&($("#deviceGraphModelName").val(n),$("#deviceGraphModelId").attr("data-id",i)),"count"==o&&($("#deviceCountModelName").val(n),$("#deviceCountModelId").attr("data-id",i)),"alarm"==o&&($("#deviceAlarmModelName").val(n),$("#deviceAlarmModelId").attr("data-id",i)),t.modal("hide")},hasMbsFunCode:"",ajaxSelect:function(e,t,a){$.ajax({url:e,data:t,type:"POST",dataType:"json",success:function(e){if(e.operCode==SUCCESS){var t;"data"==a?(t=e.data.data,hasMbsFunCode=e.data.hasMbsFunCode,console.log(hasMbsFunCode)):t=e.data;var o={data:{key:{children:"nodelist",name:"name"},keep:{parent:!1,leaf:!1}},key:{name:"name"},view:{dblClickExpand:!1},callback:{onClick:deviceClick}};$.fn.zTree.init($("#TreeBody"),o,t)}else{if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;var n=codeToMsg(e.operCode);Message.openInfo("信息提示",n,3e3)}},error:function(e){e.responseText==ERR_MSG&&Message.openInfo("信息提示","服务器繁忙！",2500)}})},deviceClick:function(e,t,a){var o=$("#hiddenSelect");if(isFileType_ModelCTFile(a.nodeType))if(isFileType_ModelCTFile(a.nodeType)){if(!1===checkSelect(a))return!1;var n=httpURL+restURL+"comTemplate/readComTemplate";$.post(n,{nodeId:a.id},function(e){if(e.operCode!=SUCCESS){if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;var t=codeToMsg(e.operCode);return Message.openInfo("信息提示",t,3e3),!1}var n=e.data.data;if(null==n||void 0==n)return Message.openInfo("信息提示","此模板为空，不能选择",2500),o.empty(),!1;$("#deviceCtId").val(),o.empty(),o.append("<option value="+a.id+">"+a.name+"</option>"),$("#connKeyDevice").val("")})}else Message.openInfo("信息提示","请选择一个通信模板！",2500);if(isFileType_ModelDTFile(a.nodeType)){if(!isFileType_ModelDTFile(a.nodeType))return Message.openInfo("信息提示","请选择数据模板！",2500),!1;if("deviceDataTemplateOther"!=dataTemplateClickType&&null!=hasMbsFunCode[a.id]&&1==hasMbsFunCode[a.id])return Message.openInfo("信息提示","该数据模板有文件记录类型，无法选择",2500),!1;if(!1===checkSelect(a))return!1;var n=httpURL+restURL+"dataTemplate/findDataTemplateDtType";$.ajax({url:n,data:{nodeId:a.id},type:"POST",dataType:"json",success:function(e){if(e.operCode==SUCCESS){var t=e.data;if(null==t||void 0==t)return Message.openInfo("信息提示","此模板为空，不能选择",2500),o.empty(),!1;var n=t.dtType,i=t.dtProp;o.empty(),o.append("<option data-prop='"+i+"' data-type='"+n+"' value='"+a.id+"'>"+a.name+"</option>"),$("#"+modalName+"DtType").val(n),""!=$("#"+modalName+"DtProp").val()&&void 0!=$("#"+modalName+"DtProp").val()||$("#"+modalName+"DtProp").val(i)}else{if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;var d=codeToMsg(e.operCode);Message.openInfo("信息提示",d,3e3)}},error:function(e){e.responseText==ERR_MSG&&Message.openInfo("信息提示","服务器繁忙！",2500)}})}if(isFileType_ModelGMFile(a.nodeType)){if(!isFileType_ModelGMFile(a.nodeType))return Message.openInfo("信息提示","请选择图形模板！",2500),!1;if(!1===checkSelect(a))return!1;var n=httpURL+restURL+"graphModel/readGraphModel";$.post(n,{nodeId:a.id},function(e){if(e.operCode!=SUCCESS){if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;var t=codeToMsg(e.operCode);return Message.openInfo("信息提示",t,3e3),!1}var n=e.data;if(null==n||void 0==n)return Message.openInfo("信息提示","此模板为空，不能选择",2500),o.empty(),!1;$("#deviceGraphModelName").val(),o.empty(),o.append("<option value="+a.id+">"+a.name+"</option>")})}if(isFileType_ModelCOUNTFile(a.nodeType)){if(!isFileType_ModelCOUNTFile(a.nodeType))return Message.openInfo("信息提示","请选择统计模板！",2500),!1;if(0==checkSelect(a))return!1;var n=httpURL+restURL+"graphModel/readGraphModel";$.post(n,{nodeId:a.id},function(e){if(e.operCode!=SUCCESS){if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;var t=codeToMsg(e.operCode);return Message.openInfo("信息提示",t,3e3),!1}var n=e.data;if(null==n||void 0==n)return Message.openInfo("信息提示","此模板为空，不能选择",2500),o.empty(),!1;$("#deviceGraphModelName").val(),o.empty(),o.append("<option value="+a.id+">"+a.name+"</option>")})}if(isFileType_ModelAIMFile(a.nodeType)){if(!isFileType_ModelAIMFile(a.nodeType))return Message.openInfo("信息提示","请选择告警模型！",2500),!1;if(!1===checkSelect(a))return!1;var n=httpURL+restURL+"triggerModel/findTriggerModel";$.post(n,{catalogId:a.id},function(e){if(e.operCode==SUCCESS){var t=e.data.data;if(null==t||void 0==t)return Message.openInfo("信息提示","此模板为空，不能选择",2500),o.empty(),!1;$("#deviceGraphModelName").val(),o.empty(),o.append("<option value="+a.id+">"+a.name+"</option>")}})}},dataItems:"",loadMbsDataItems:function(e,t){var a=httpURL+restURL+"dataTemplate/readDataTemplateFilter";$.ajax({url:a,data:{nodeId:e},type:"POST",dataType:"json",success:function(e){if(e.operCode!=SUCCESS){if(e.operCode==SESSION_TIMEOUT)return Message.openInfo("信息提示","请重新登陆",3e3),!1;if(e.operCode==NULL_PARAM)return Message.openInfo("信息提示","缺少必要参数",3e3),!1;var a=codeToMsg(e.operCode);return Message.openInfo("信息提示",a,3e3),!1}var o=e.data.data;allDataItem=o;var n=o.subDataModelList,i=$("#select2").children();if(0==i.length){for(var d in n)if(20!=t){if("03"==t){if("3"==n[d].funCode){var r=n[d].subDataModelList;r.sort(function(e,t){return e.offSet-t.offSet});for(var l in r)$("#select1").append("<option data-funcode='03' id='"+r[l].id+"' unit='"+r[l].unit+"'>"+r[l].name+"</option>")}}else if("16"==n[d].funCode){var r=n[d].subDataModelList;r.sort(function(e,t){return e.offSet-t.offSet});for(var l in r)$("#select1").append("<option data-funcode='16' id='"+r[l].id+"' unit='"+r[l].unit+"'>"+r[l].name+"</option>")}}else if(20==n[d].funCode){var r=n[d].subDataModelList;for(var l in r)$("#select1").append("<option  data-funcode='20' id='"+r[l].id+"' unit='"+r[l].unit+"'>"+r[l].name+"</option>")}}else{$("#select1").empty();for(var d in n)if(20!=t){if("03"==t&&"3"==n[d].funCode){var r=n[d].subDataModelList;$.each(i,function(e,t){for(var a in r)if($(t).attr("id")==r[a].id){r.splice(a,1);break}});for(var d=0;d<r.length;d++)$("#select1").append("<option data-funcode='03' id='"+r[d].id+"' unit='"+r[d].unit+"'>"+r[d].name+"</option>")}if("16"==t&&"16"==n[d].funCode){var r=n[d].subDataModelList;$.each(i,function(e,t){for(var a in r)if($(t).attr("id")==r[a].id){r.splice(a,1);break}});for(var d=0;d<r.length;d++)$("#select1").append("<option data-funcode='16' id='"+r[d].id+"' unit='"+r[d].unit+"'>"+r[d].name+"</option>")}}else if(20==n[d].funCode){var r=n[d].subDataModelList;$.each(i,function(e,t){for(var a in r)if($(t).attr("id")==r[a].id){r.splice(a,1);break}});for(var d=0;d<r.length;d++)$("#select1").append("<option data-funcode='20' id='"+r[d].id+"' unit='"+r[d].unit+"'>文件"+r[d].fileNo+"</option>")}}},error:function(e){console.log("err",e)}})},codeToMsg:function(e){return 1001==e||1002==e?"连接超时":2001==e||2002==e||2003==e||2004==e?"服务器繁忙":2e3==e?"暂无数据":3e3==e?"缺少必要参数":3002==e?"参数错误":2005==e?"不能创建同名模板":4001==e?"请重新登陆":void 0},isIntegerFunc:function(e){return""!=e&&(3840&e)>>8==0},isByteCountFunc:function(e){return""==e?0:(61440&e)>>12},isSigned:function(e){return""!=e&&(240&e)>>4==1},isTcpIpClient:function(e){return 16==e},isTcpIpServer:function(e){return 4112==e},isOPCDAServer:function(e){return 4117==e},isModBus:function(e){return(e>>8&255)==COMBASICTYPE3_MODBUS},isOPCDA:function(e){return(e>>8&255)==MESSAGECODE_BASICTYPE3_OPCDA},setMbapType:function(e,t){return e|=(1&t)<<1},getMbapType:function(e){return(2&e)>>1},setCheckType:function(e,t){return e|=t<<16&983040},getCheckType:function(e){return(983040&e)>>16},setEndianType:function(e,t){return e|=1&t},getEndianType:function(e){return 1&e},setCodeType:function(e,t){return e|=t<<8&3840},getCodeType:function(e){return(3840&e)>>8},setMergeTimeNum:function(e,t){return e|=t<<24&2130706432},getMergeTimeNum:function(e){return e>>24&127},setTimeUnit:function(e,t){return e|=t<<20&3145728},getTimeUnit:function(e){return(3145728&e)>>20},addPreZero:function(e,t){var o,n,i="";e=e.toString();for(var d=0;d<4-e.length;d++)i="0"+i;switch(e=i+e,t){case"ins":o="增加",n=0;break;case"del":o="删除",n=1;break;case"upd":o="更改",n=2;break;case"sel":o="查询",n=3}return 0===parseInt(e.charAt(n))?(a.msg("很抱歉您没有权限"+o,{icon:0,shift:6}),!1):1===parseInt(e.charAt(n))||(a.msg("请输入正确的格式",{icon:0,shift:6}),!1)},cancel:function(){var o={_ajax:"ajax"};t.getInvalidateUser(o).then(function(t){if("true"===t.data.result){n.clearStorage();"login"==e.current.name?e.reload(e.current.name):e.go("login",{},{reload:!0})}else a.alert(t.message,{icon:5,shift:6})})},clearStorage:function(){localStorage.removeItem("sessionId"),localStorage.removeItem("userInfo"),localStorage.removeItem("menuDisplayWayDev"),sessionStorage.clear()}};return n}e.module("app.service").factory("COMMONJS",t),t.$inject=["$state","JEEAPI","layer","TEMPLATEDATA"]}(window.angular);